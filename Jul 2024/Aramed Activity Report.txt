

CREATE PROC udp_Activities(@iTransId bigint,@iUserId int=0)

as
begin
select @iTransId=dbo.fCrm_IntToAPITransId(@iTransId,0)

update vCrm_Activities set Duration=dbo.fCrm_DATEDIFF(5,iStartDatetime,iEndDatetime)  where iTransId=@iTransId
end 

select CONCAT_WS(' ','exec udp_TeleCalls',iTransId,',0'),Duration,* from vCrm_Activities where iTransId>0

CREATE PROC udp_Appointments(@iTransId bigint,@iUserId int=0)

as
begin
select @iTransId=dbo.fCrm_IntToAPITransId(@iTransId,0)

update vCrm_Appointments set Duration=dbo.fCrm_DATEDIFF(5,iStartDatetime,iEndDatetime)  where iTransId=@iTransId
end 

select CONCAT_WS(' ','exec udp_TeleCalls',iTransId,',0'),Duration,* from vCrm_Appointments where iTransId>0

CREATE PROC udp_TeleCalls(@iTransId bigint,@iUserId int=0)

as
begin
select @iTransId=dbo.fCrm_IntToAPITransId(@iTransId,0)

update vCrm_TeleCalls set Duration=dbo.fCrm_DATEDIFF(5,iStartDatetime,iEndDatetime)  where iTransId=@iTransId
end 

select CONCAT_WS(' ','exec udp_TeleCalls',iTransId,',0'),Duration,* from vCrm_TeleCalls where iTransId>0
==================================================================================================================================


ALTER VIEW [dbo].[nCrm_AllActivities] as

select 
  b.sFirstName FirstName,c.sCaption Caption,a.iRelatedTo RelatedTo ,b.sCode LoginName,b.iMasterId ccol3,a.sSubject sSubject,e.sName AccountBranch,d.Branch ccol5, h.sName Purpose,
  i.sName LeadBranch,a.iCreatedDate [$Datetime$Created Date],a.iStartDatetime [$Datetime$StartDateTime], a.iEndDatetime [$Datetime$EndDateTime],a.sDescription col11, 
  j.sName [Task Status],j.iTransId ccol12,c.sModuleName ModuleName,p1.sName Product1,p2.sName Product2,p3.sName Product3,
  case l.[Classification] when '1' then  'A' when '2' then  'A+' when '3' then 'B' when '4' then  'C' when '5' then  'D' end [Classification] ,sm.sName [SalesMan],l.sName [Doctor],a.sContactName,a.sLocation,
  CASE a.iRelatedToType when 256 then f.sName when 1792 then acc.sName when 2305 then d.sName when 2310 then m.sName when 2462 then n.sName when 2473 then q.sName when 2482 then r.sName when 2483 then s.sName when 2484 then t.sName when 2485 then u.sName when 2486 then v.sName when 2495 then w.sName when 2496 then x.sName when 2498 then y.sName when 2499 then z.sName when 2476 then aa.sName
  end [Name],a.Duration
from 
  vCrm_Activities a with(NOLOCK)
  left join vCrm_Users b with(NOLOCK) on a.iCreatedBy = b.iMasterId 
  left join vCrm_ModuleTypes c with(NOLOCK) on a.iRelatedToType = c.iTypeId 
  left join vCore_Account d with(NOLOCK) on a.iRelatedTo = d.iMasterId 
  left join vCore_Branch e with(NOLOCK) on d.Branch = e.iMasterId 
  left join vaCrm_Leads f with(NOLOCK) on a.iRelatedTo = f.iTransId 
  left join vCrm_Appointments g with(NOLOCK) on f.iAppointmentId = g.iTransId 
  left join vCrm_PurposeOfVisit h with(NOLOCK) on a.iPurposeId = h.iTransId 
  left join vCore_Branch i with(NOLOCK) on f.Branch = i.iMasterId 
  left join vCrm_TaskStatus j with(NOLOCK) on a.iStatus = j.iTransId 
  left join vCrm_ModuleTypes k with(NOLOCK) on a.iTypeId = k.iMasterId 
left join vCore_Product p1 with(NOLOCK) on a.Product1=p1.iMasterId
left join vCore_Product p2 with(NOLOCK) on a.Product2=p2.iMasterId
left join vCore_Product p3 with(NOLOCK) on a.Product3=p3.iMasterId
left join vCore_Salesman sm with(NOLOCK) on a.Salesman=sm.iMasterId
  left join vCore_Doctor l with(NOLOCK) on a.Doctor = l.iMasterId 
  left join vCrm_Campaigns m with(NOLOCK) on a.iRelatedTo=m.iMasterId
  left join vCore_Salesman n with(nolock) on a.iRelatedTo=n.iMasterId
  left join vCrm_Opportunities o with(nolock) on a.iRelatedTo=o.iTransId
  left join vCore_Account acc with(nolock) on o.iAccount=acc.iMasterId
  left join vCrm_Contacts p with(nolock) on a.iRelatedTo=p.iMasterId
  left join vCore_DemoRequest q with(nolock) on a.iRelatedTo=q.iMasterId
  left join vCore_Doctor r with(nolock) on a.iRelatedTo=r.iMasterId
  left join vCore_ClinicMaster s with(nolock) on a.iRelatedTo=s.iMasterId
  left join vCore_EventMaster t with(nolock) on a.iRelatedTo=t.iMasterId
  left join vCrm_Calls u with(nolock) on a.iRelatedTo=u.iTransId
  left join vCore_SampleRequest v with(nolock) on a.iRelatedTo=v.iMasterId
  left join vCore_RentalRequest w with(nolock) on a.iRelatedTo=w.iMasterId
  left join vCore_RepairRequest x with(nolock) on a.iRelatedTo=x.iMasterId
  left join vCore_RentalRequestNo y with(nolock) on a.iRelatedTo=y.iMasterId
  left join vCore_DemoRequestNo z with(nolock) on a.iRelatedTo=z.iMasterId
  left join vCore_TrainingRequest aa with(nolock) on a.iRelatedTo=aa.iMasterId

where  
  a.iTransId>0

  union all

  select 
  b.sFirstName FirstName,c.sCaption Caption,a.iRelatedTo RelatedTo ,b.sCode LoginName, b.iMasterId ccol3,a.sSubject sSubject,e.sName AccountBranch,d.Branch ccol5, '',
  i.sName LeadBranch,a.iCreatedDate [$Datetime$Created Date], 0 ,0,a.sDescription col11, j.sName [Task Status],j.iTransId ccol12, c.sModuleName ModuleName,'','','','','','',a.sContactName,'',CASE a.iRelatedToType when 256 then f.sName when 1792 then acc.sName when 2305 then d.sName when 2310 then m.sName when 2462 then n.sName when 2473 then q.sName when 2482 then r.sName when 2483 then s.sName when 2484 then t.sName when 2485 then u.sName when 2486 then v.sName when 2495 then w.sName when 2496 then x.sName when 2498 then y.sName when 2499 then z.sName when 2476 then aa.sName
  end [Name],0
from 
  vCrm_Tasks a with(NOLOCK)
  left join vCrm_Users b with(NOLOCK) on a.iCreatedBy = b.iMasterId 
  left join vCrm_ModuleTypes c with(NOLOCK) on a.iRelatedToType = c.iTypeId 
  left join vCore_Account d with(NOLOCK) on a.iRelatedTo = d.iMasterId 
  left join vCore_Branch e with(NOLOCK) on d.Branch = e.iMasterId 
  left join vaCrm_Leads f with(NOLOCK) on a.iRelatedTo = f.iTransId 
  left join vCrm_Appointments g with(NOLOCK) on f.iAppointmentId = g.iTransId 
  left join vCore_Branch i with(NOLOCK) on f.Branch = i.iMasterId 
  left join vCrm_TaskStatus j with(NOLOCK) on a.iStatus = j.iTransId 
  left join vCrm_ModuleTypes k with(NOLOCK) on a.iTypeId = k.iMasterId 
    left join vCrm_Campaigns m with(NOLOCK) on a.iRelatedTo=m.iMasterId
	
  left join vCore_Salesman n with(nolock) on a.iRelatedTo=n.iMasterId
  left join vCrm_Opportunities o with(nolock) on a.iRelatedTo=o.iTransId
  left join vCrm_Contacts p with(nolock) on a.iRelatedTo=p.iMasterId
  left join vCore_DemoRequest q with(nolock) on a.iRelatedTo=q.iMasterId
  left join vCore_Doctor r with(nolock) on a.iRelatedTo=r.iMasterId
  left join vCore_ClinicMaster s with(nolock) on a.iRelatedTo=s.iMasterId
  left join vCore_EventMaster t with(nolock) on a.iRelatedTo=t.iMasterId
  left join vCrm_Calls u with(nolock) on a.iRelatedTo=u.iTransId
  left join vCore_SampleRequest v with(nolock) on a.iRelatedTo=v.iMasterId
  left join vCore_RentalRequest w with(nolock) on a.iRelatedTo=w.iMasterId
  left join vCore_RepairRequest x with(nolock) on a.iRelatedTo=x.iMasterId
  left join vCore_RentalRequestNo y with(nolock) on a.iRelatedTo=y.iMasterId
  left join vCore_DemoRequestNo z with(nolock) on a.iRelatedTo=z.iMasterId
  left join vCore_TrainingRequest aa with(nolock) on a.iRelatedTo=aa.iMasterId
  left join vCore_Account acc with(nolock) on o.iAccount=acc.iMasterId

where 
  a.iTransId>0

  union all

  select 
  b.sFirstName FirstName,c.sCaption Caption,a.iRelatedTo RelatedTo ,b.sCode LoginName,b.iMasterId ccol3,a.sSubject sSubject,e.sName AccountBranch,d.Branch ccol5,h.sName Purpose,
  i.sName LeadBranch,a.iCreatedDate [$Datetime$Created Date],a.iStartDatetime [$Datetime$StartDateTime],a.iEndDatetime [$Datetime$EndDateTime], a.sDescription col11, j.sName [Task Status],j.iTransId ccol12,c.sModuleName ModuleName,'','','','','','',a.sContactName,a.sLocation,CASE a.iRelatedToType when 256 then f.sName when 1792 then acc.sName when 2305 then d.sName when 2310 then m.sName when 2462 then n.sName when 2473 then q.sName when 2482 then r.sName when 2483 then s.sName when 2484 then t.sName when 2485 then u.sName when 2486 then v.sName when 2495 then w.sName when 2496 then x.sName when 2498 then y.sName when 2499 then z.sName when 2476 then aa.sName
  end [Name],a.Duration
from 
  vCrm_Appointments a with(NOLOCK)
  left join vCrm_Users b with(NOLOCK) on a.iCreatedBy = b.iMasterId 
  left join vCrm_ModuleTypes c with(NOLOCK) on a.iRelatedToType = c.iTypeId 
  left join vCore_Account d with(NOLOCK) on a.iRelatedTo = d.iMasterId 
  left join vCore_Branch e with(NOLOCK) on d.Branch = e.iMasterId 
  left join vaCrm_Leads f with(NOLOCK) on a.iRelatedTo = f.iTransId 
  left join vCrm_Appointments g with(NOLOCK) on f.iAppointmentId = g.iTransId 
  left join vCrm_PurposeOfVisit h with(NOLOCK) on a.iPurposeId = h.iTransId 
  left join vCore_Branch i with(NOLOCK) on f.Branch = i.iMasterId 
  left join vCrm_TaskStatus j with(NOLOCK) on a.iStatus = j.iTransId 
  left join vCrm_ModuleTypes k with(NOLOCK) on a.iTypeId = k.iMasterId 
    left join vCrm_Campaigns m with(NOLOCK) on a.iRelatedTo=m.iMasterId
	
  left join vCore_Salesman n with(nolock) on a.iRelatedTo=n.iMasterId
  left join vCrm_Opportunities o with(nolock) on a.iRelatedTo=o.iTransId
  left join vCrm_Contacts p with(nolock) on a.iRelatedTo=p.iMasterId
  left join vCore_DemoRequest q with(nolock) on a.iRelatedTo=q.iMasterId
  left join vCore_Doctor r with(nolock) on a.iRelatedTo=r.iMasterId
  left join vCore_ClinicMaster s with(nolock) on a.iRelatedTo=s.iMasterId
  left join vCore_EventMaster t with(nolock) on a.iRelatedTo=t.iMasterId
  left join vCrm_Calls u with(nolock) on a.iRelatedTo=u.iTransId
  left join vCore_SampleRequest v with(nolock) on a.iRelatedTo=v.iMasterId
  left join vCore_RentalRequest w with(nolock) on a.iRelatedTo=w.iMasterId
  left join vCore_RepairRequest x with(nolock) on a.iRelatedTo=x.iMasterId
  left join vCore_RentalRequestNo y with(nolock) on a.iRelatedTo=y.iMasterId
  left join vCore_DemoRequestNo z with(nolock) on a.iRelatedTo=z.iMasterId
  left join vCore_TrainingRequest aa with(nolock) on a.iRelatedTo=aa.iMasterId
  left join vCore_Account acc with(nolock) on o.iAccount=acc.iMasterId
where 
  a.iTransId>0


  union all

    select 
  b.sFirstName FirstName,c.sCaption Caption,a.iRelatedTo RelatedTo ,b.sCode LoginName,b.iMasterId ccol3,a.sSubject sSubject,e.sName AccountBranch,d.Branch ccol5,h.sName Purpose,
  i.sName LeadBranch,a.iCreatedDate [$Datetime$Created Date],a.iStartDatetime [$Datetime$StartDateTime],a.iEndDatetime [$Datetime$EndDateTime], a.sDescription col11, j.sName [Task Status],j.iTransId ccol12,c.sModuleName ModuleName,'','','','','','',a.sContactName,a.sLocation,CASE a.iRelatedToType when 256 then f.sName when 1792 then acc.sName when 2305 then d.sName when 2310 then m.sName when 2462 then n.sName when 2473 then q.sName when 2482 then r.sName when 2483 then s.sName when 2484 then t.sName when 2485 then u.sName when 2486 then v.sName when 2495 then w.sName when 2496 then x.sName when 2498 then y.sName when 2499 then z.sName when 2476 then aa.sName
  end [Name],a.Duration
from 
  vCrm_Plans a with(NOLOCK)
  left join vCrm_Users b with(NOLOCK) on a.iCreatedBy = b.iMasterId 
  left join vCrm_ModuleTypes c with(NOLOCK) on a.iRelatedToType = c.iTypeId 
  left join vCore_Account d with(NOLOCK) on a.iRelatedTo = d.iMasterId 
  left join vCore_Branch e with(NOLOCK) on d.Branch = e.iMasterId 
  left join vaCrm_Leads f with(NOLOCK) on a.iRelatedTo = f.iTransId 
  left join vCrm_Appointments g with(NOLOCK) on f.iAppointmentId = g.iTransId 
  left join vCrm_PurposeOfVisit h with(NOLOCK) on a.iPurposeId = h.iTransId 
  left join vCore_Branch i with(NOLOCK) on f.Branch = i.iMasterId 
  left join vCrm_TaskStatus j with(NOLOCK) on a.iStatus = j.iTransId 
  left join vCrm_ModuleTypes k with(NOLOCK) on a.iTypeId = k.iMasterId 
    left join vCrm_Campaigns m with(NOLOCK) on a.iRelatedTo=m.iMasterId
	
  left join vCore_Salesman n with(nolock) on a.iRelatedTo=n.iMasterId
  left join vCrm_Opportunities o with(nolock) on a.iRelatedTo=o.iTransId
  left join vCrm_Contacts p with(nolock) on a.iRelatedTo=p.iMasterId
  left join vCore_DemoRequest q with(nolock) on a.iRelatedTo=q.iMasterId
  left join vCore_Doctor r with(nolock) on a.iRelatedTo=r.iMasterId
  left join vCore_ClinicMaster s with(nolock) on a.iRelatedTo=s.iMasterId
  left join vCore_EventMaster t with(nolock) on a.iRelatedTo=t.iMasterId
  left join vCrm_Calls u with(nolock) on a.iRelatedTo=u.iTransId
  left join vCore_SampleRequest v with(nolock) on a.iRelatedTo=v.iMasterId
  left join vCore_RentalRequest w with(nolock) on a.iRelatedTo=w.iMasterId
  left join vCore_RepairRequest x with(nolock) on a.iRelatedTo=x.iMasterId
  left join vCore_RentalRequestNo y with(nolock) on a.iRelatedTo=y.iMasterId
  left join vCore_DemoRequestNo z with(nolock) on a.iRelatedTo=z.iMasterId
  left join vCore_TrainingRequest aa with(nolock) on a.iRelatedTo=aa.iMasterId
  left join vCore_Account acc with(nolock) on o.iAccount=acc.iMasterId
where 
  a.iTransId>0


  union all

    select 
  b.sFirstName FirstName,c.sCaption Caption,a.iRelatedTo RelatedTo ,b.sCode LoginName,b.iMasterId ccol3,a.sSubject sSubject,e.sName AccountBranch,d.Branch ccol5,h.sName Purpose,
  i.sName LeadBranch,a.iCreatedDate [$Datetime$Created Date],a.iStartDatetime [$Datetime$StartDateTime],a.iEndDatetime [$Datetime$EndDateTime], a.sDescription col11, j.sName [Task Status],j.iTransId ccol12,c.sModuleName ModuleName,'','','','','','',a.sContactName,a.sLocation,CASE a.iRelatedToType when 256 then f.sName when 1792 then acc.sName when 2305 then d.sName when 2310 then m.sName when 2462 then n.sName when 2473 then q.sName when 2482 then r.sName when 2483 then s.sName when 2484 then t.sName when 2485 then u.sName when 2486 then v.sName when 2495 then w.sName when 2496 then x.sName when 2498 then y.sName when 2499 then z.sName when 2476 then aa.sName
  end [Name],a.Duration
from 
  vCrm_TeleCalls a with(NOLOCK)
  left join vCrm_Users b with(NOLOCK) on a.iCreatedBy = b.iMasterId 
  left join vCrm_ModuleTypes c with(NOLOCK) on a.iRelatedToType = c.iTypeId  
  left join vCore_Account d with(NOLOCK) on a.iRelatedTo = d.iMasterId 
  left join vCore_Branch e with(NOLOCK) on d.Branch = e.iMasterId 
  left join vaCrm_Leads f with(NOLOCK) on a.iRelatedTo = f.iTransId 
  left join vCrm_Appointments g with(NOLOCK) on f.iAppointmentId = g.iTransId 
  left join vCrm_PurposeOfVisit h with(NOLOCK) on a.iPurposeId = h.iTransId 
  left join vCore_Branch i with(NOLOCK) on f.Branch = i.iMasterId
  left join vCrm_TaskStatus j with(NOLOCK) on a.iStatus = j.iTransId 
  left join vCrm_ModuleTypes k with(NOLOCK) on a.iTypeId = k.iMasterId 
    left join vCrm_Campaigns m with(NOLOCK) on a.iRelatedTo=m.iMasterId
	
  left join vCore_Salesman n with(nolock) on a.iRelatedTo=n.iMasterId
  left join vCrm_Opportunities o with(nolock) on a.iRelatedTo=o.iTransId
  left join vCrm_Contacts p with(nolock) on a.iRelatedTo=p.iMasterId
  left join vCore_DemoRequest q with(nolock) on a.iRelatedTo=q.iMasterId
  left join vCore_Doctor r with(nolock) on a.iRelatedTo=r.iMasterId
  left join vCore_ClinicMaster s with(nolock) on a.iRelatedTo=s.iMasterId
  left join vCore_EventMaster t with(nolock) on a.iRelatedTo=t.iMasterId
  left join vCrm_Calls u with(nolock) on a.iRelatedTo=u.iTransId
  left join vCore_SampleRequest v with(nolock) on a.iRelatedTo=v.iMasterId
  left join vCore_RentalRequest w with(nolock) on a.iRelatedTo=w.iMasterId
  left join vCore_RepairRequest x with(nolock) on a.iRelatedTo=x.iMasterId
  left join vCore_RentalRequestNo y with(nolock) on a.iRelatedTo=y.iMasterId
  left join vCore_DemoRequestNo z with(nolock) on a.iRelatedTo=z.iMasterId
  left join vCore_TrainingRequest aa with(nolock) on a.iRelatedTo=aa.iMasterId
  left join vCore_Account acc with(nolock) on o.iAccount=acc.iMasterId
where 
  a.iTransId>0




GO


