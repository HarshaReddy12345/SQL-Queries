EXEC sp_configure 'Ole Automation Procedures';
GO
sp_configure 'show advanced options', 1;
GO
RECONFIGURE;
GO
sp_configure 'Ole Automation Procedures', 1;
GO
RECONFIGURE;
GO

create function SendGetRequest(@url varchar(8000)) returns varchar(8000) 
as 
BEGIN 
	DECLARE @win int DECLARE @hr int DECLARE @text varchar(8000)
	EXEC @hr = sp_OACreate 'WinHttp.WinHttpRequest.5.1', @win OUT IF @hr <> 0
	EXEC sp_OAGetErrorInfo @win 
	EXEC @hr = sp_OAMethod @win,'Open', NULL, 'GET',@url,'false' IF @hr <> 0
	EXEC sp_OAGetErrorInfo @win 
	EXEC @hr = sp_OAMethod @win,'Send' IF @hr <> 0 
	EXEC sp_OAGetErrorInfo @win 
	EXEC @hr = sp_OAGetProperty @win,'ResponseText',@text OUTPUT IF @hr <> 0 
	EXEC sp_OAGetErrorInfo @win 
	EXEC @hr = sp_OADestroy @win IF @hr <> 0
	EXEC sp_OAGetErrorInfo @win 
	RETURN @text 
END
go

CREATE function dbo.GetAvgRate(@iProdId int)
returns decimal(18,2)
as
begin
	declare @fret decimal(18,2)
	declare @sUrl varchar(max)='https://ca.focus9erp.com/Focus8api/GetExecSqlScalar?sCompCode=050&SqlCommand=';

	declare @sDate varchar(20) = convert(varchar(20),dbo.fCore_DateToInt(getdate()))
	declare @sCode varchar(300)
	--select @iProdId = @s.value('(Fields/BodyData/BodyRow/BOMProduct)[1]','int');
	
	select @sCode= sCode from vCore_Product with(nolock) where iMasterId=@iProdId;
	

	set @sUrl = @sUrl+'declare @fret decimal(18,2),@iMasterid int=0 
	select top 1 @iMasterid=iMasterId from vCore_Product with(nolock) where sCode='''+@sCode+'''
	select @fret=[dbo].[avgrate](@iMasterid,@sDate,0,0,1) select @fret';
	select @fret=convert(decimal(18,2),value) from OPENJSON(dbo.SendGetRequest(@sUrl)) 
	with (url varchar(500) '$.url',data2 nvarchar(max) '$.data' as JSON, result int '$.result')
	cross apply openjson(data2) with (Obj1 nvarchar(max) '$' as json)
	cross apply openjson(Obj1) 
	return @fret
end






