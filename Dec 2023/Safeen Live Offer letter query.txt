ALTER VIEW nCore_OfferletterHeader as    
SELECT      
  a.iTransId,      
  FORMAT(GETDATE(), 'dd MMMM yyyy') [RUNDATE],      
  b.sName [ContactName],      
  b.sLastName,      
  c.sName [AccountName],      
  c.sBillingAddress,      
  c.sBillingCity,      
  d.sName [Acc Country],      
  b.sPhone,      
  b.sEmail,      
  e.sName [Owner],      
  e.TelephoneNo,      
  e.Email [Owner Mail],      
  f.sName [Opportunity],      
  a.sName [Offer No],      
  g.sName [Ship],      
  h.sName [Brand],      
  FORMAT(dbo.fCore_IntToDate(a.SailDate), 'dd MMMM yyyy') [SailingDate],      
  i.sName [Itinerary],      
   CASE a.BookingStatus      
    WHEN 1 THEN 'OFFERED / COURTESY HOLD'      
    WHEN 2 THEN 'CONFIRMED'      
 when 3 then 'CANCELLED'  
  END BookingStatus,     
  ((a.TotalBalanceAfterRefund)-(DepositDue))  [Bal],  
  CASE      
    WHEN ((a.TotalBalanceAfterRefund)-(DepositDue)) IS NULL OR      
      ((a.TotalBalanceAfterRefund)-(DepositDue)) = 0.00 THEN null      
    ELSE CONCAT( 'USD ', ((a.TotalBalanceAfterRefund)-(DepositDue)),'  by ',FORMAT(dbo.fCore_IntToDate(a.PaymentDueDate), 'dd MMMM yyyy'),';16:00 UAE Time' )      
  END TotalBalanceAfterRefund,      
  CASE      
    WHEN a.DepositDue IS NULL OR      
      a.DepositDue = 0 THEN ''      
    ELSE CONCAT( 'USD ', CAST(a.DepositDue AS varchar(max)),' by ',FORMAT(dbo.fCore_IntToDate(OptionDate), 'dd MMMM yyyy') ,';16:00 UAE Time')      
  END AS DepositDue,      
  a.Gratuities,a.Message2  ,CONCAT('http://localhost:8080/ResourceFromCRM/getres?cc=3B0&docid=',iDocId) sImageUrl,a.AssistCardInfo,    
c.TRNNumber ,a.ItineraryDescription   
FROM vCrm_SalesOrder a WITH (NOLOCK)      
JOIN vCrm_Contacts b WITH (NOLOCK)      
  ON a.iContactId = b.iMasterId      
JOIN vCore_Account c WITH (NOLOCK)      
  ON a.AccountName = c.iMasterId      
JOIN vCore_Country d WITH (NOLOCK)      
  ON c.iBillingCountry = d.iMasterId      
LEFT JOIN vCore_Salesman e WITH (NOLOCK)      
  ON a.ReservationStaff = e.iMasterId      
JOIN vCrm_Opportunities f WITH (NOLOCK)      
  ON a.iOpportunityId = f.iTransId      
JOIN vCore_Ship g WITH (NOLOCK)      
  ON a.Ship = g.iMasterId      
JOIN vCore_Brand h WITH (NOLOCK)      
  ON g.Brand = h.iMasterId      
JOIN vCore_Itinerary i WITH (NOLOCK)      
  ON a.Itinerary = i.iMasterId      
LEFT join (select dbo.fCrm_getAPITransId(vCrm_Documents.iMasterId,2563,0) iDocId,iRelatedTo     
from vCrm_Documents with(nolock)     
where iModuleTypeId=3072 and iFieldId=301376) Docs on Docs.iRelatedTo=a.iTransId    
WHERE a.iTransId>0

----------------------------------------------------------------------------------------------------------
   alter VIEW nCore_OfferLetterProductGrid as      
SELECT      
  a.iTransId,      
  b.sCode [Booking ID],     
  b.sName [Booking ID Name],    
  d.sCode [CatCode],      
  a.CabinCategoryName,      
  CabinNo,      
  a.iQuantity [Guests],      
  a.GuestName,      
  b.FirstName1,      
  b.LastName1,      
  b.FirstName2,      
  b.LastName2,      
  b.FirstName3,      
  b.LastName3,      
  b.FirstName4,      
  b.LastName4,      
  c.sName Dining,      
  a.Remarks,      
  NetCruiseFare,      
  (NCCF + FCCLOC + OtherSavings) [Nccf],      
  a.Taxes,      
  a.ServiceCharge [Gratitues],      
  a.AssistCard,      
  (a.FuelSupplement + a.Transfers + PrePost + a.OtherCharge) [Other Charges],      
  a.TotalChargeUSD,      
  (a.AgencyCommissionamount + CMgntDiscount) [Agency Commission], a.GrossTotal,     
  a.CNetCharges,a.TotalCommision,a.Management,(a.GrossTotal +a.TotalCommision+a.Management) [Value Added Tax],a.TotalNetDueafterVAT,    
  a.ReceiptAmt,a.RefundAmt,a.AmountDueInOtherCurrency,TotalReceiptAmount,TotalRefundAmount,TotalVATAmount,TotalNetCharge,TotalBalanceAfterRefund,  
  AgencyCommissionPercentage  ,a.iSequence,b.FITID
FROM vuCrm_SalesOrder_General_Details a WITH (NOLOCK)      
JOIN vCore_Product b WITH (NOLOCK)      
  ON a.iProductId = b.iMasterId      
JOIN vCore_Dinning c WITH (NOLOCK)      
  ON a.Dining = c.iMasterId      
JOIN vCore_CabinCategory d with(NOLOCK)      
  ON a.CabinCategoryCode=d.iMasterId      
WHERE a.iTransId>0    

