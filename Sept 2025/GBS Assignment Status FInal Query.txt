ALTER VIEW nCore_AssignmentStatusReport      
AS      
SELECT       
    ISNULL([Staff Name], '') AS [Staff Name],      
    ISNULL([StaffId],0) [StaffId],      
    ISNULL([SubProjectId],'') as [SubProjectId],      
    ISNULL([Sub Project], '') AS [Sub Project],      
    ISNULL([Assignment Type],'') [Assignment Type],      
    ISNULL([Estimated Hrs],0.00) [Estimated Hrs],      
    ISNULL([Actual Hours],0.00) [Actual Hours],      
    ISNULL([Estimated Hrs],0.00)-ISNULL([Actual Hours],0.00) [Variance],  
    ISNULL([Deadline Date],'') as  [Deadline Date],      
    ISNULL(KeyIssues,'') [Key Issues],      
    ISNULL(Deliverables,'') [Deliverables],      
    iMasterId,      
    ISNULL([Invoice Amt],0.00) [Invoice Amt],      
    ISNULL([Confirmed], '') AS [Confirmed],      
    ISNULL([Field Work], '') AS [Field Work],      
    ISNULL([Query Sent], '') AS [Query Sent],      
    ISNULL([Query Solved], '') AS [Query Solved],      
    ISNULL([Report Prepared], '') AS [Report Prepared],      
    ISNULL([Review], '') AS [Review],      
    ISNULL([Draft Issued No1], '') AS [Draft Issued No1],      
    ISNULL([Draft - Final],'') AS [Draft - Final],      
    ISNULL([Report Issued], '') AS [Report Issued],      
    ISNULL([Signed], '') AS [Signed],      
    ISNULL([Work Suspended], '') AS [Work Suspended],     
    ISNULL(Remarks1, '') AS [Remarks1]      
  
FROM (      
    SELECT       
        ISNULL(c.sName, '') AS [Staff Name],      
        CASE       
            WHEN a.ForReportMaster =1 THEN 'Confirmed'      
            WHEN a.ForReportMaster=9 THEN 'Field Work'      
            WHEN a.ForReportMaster =11 THEN 'Query Sent'      
            WHEN a.ForReportMaster=12 THEN 'Query Solved'      
            WHEN a.ForReportMaster=5 THEN 'Report Prepared'      
            WHEN a.ForReportMaster =14 THEN 'Review'      
            WHEN a.ForReportMaster =8 THEN 'Draft Issued No1'      
            WHEN a.ForReportMaster =7 THEN 'Draft - Final'      
            WHEN a.ForReportMaster =6 THEN 'Report Issued'      
            WHEN a.ForReportMaster =13 THEN 'Signed'      
            WHEN a.ForReportMaster =4 THEN 'Work Suspended'      
            ELSE a.sName END AS [Task Status],       
    
            CASE WHEN LEN(b.CompletionDate) = 9  THEN FORMAT(dbo.fCore_IntToDate(b.CompletionDate), 'dd/MM/yyyy') ELSE '' END AS [Val],      
    
            ISNULL(d.sName, '') AS [Sub Project],      
            CASE WHEN LEN(d.DeadlineDate) = 9 THEN FORMAT(dbo.fCore_IntToDate(d.DeadlineDate), 'dd/MM/yyyy')  ELSE '' END [Deadline Date],      
            d.KeyIssues,      
            d.iMasterId [SubProjectId],      
    
            -- Estimated Hours calculation
            (SELECT CAST(FLOOR(SUM(ISNULL(PlannedHours, 0))) + 
                    FLOOR((SUM(ISNULL(PlannedHours, 0)) - FLOOR(SUM(ISNULL(PlannedHours, 0)))) * 100 / 60) +  
                    (((SUM(ISNULL(PlannedHours, 0)) - FLOOR(SUM(ISNULL(PlannedHours, 0)))) * 100) % 60) / 100.0  
                    AS DECIMAL(18,2))
            FROM vuCore_SubProject_TaskAllocation_Details 
            WHERE iMasterId = d.iMasterId) [Estimated Hrs],      
    
           -- Actual Hours calculation with error handling
              CASE WHEN EXISTS (SELECT 1 FROM vuCore_Timesheet_TimeandAttendanceInformation_Details t WHERE t.SubProject > 0
              AND t.SubProject = d.iMasterId) THEN ISNULL((
              SELECT CAST( REPLACE(CONVERT(VARCHAR(5), RIGHT('0' + CAST((CAST(LEFT(dbo.fCore_IntToTime(SUM(CASE WHEN ISNUMERIC(Time1) = 1 THEN CAST(Time1 AS INT) ELSE 0 END)), 2) AS INT)+ (CAST(SUBSTRING(dbo.fCore_IntToTime(SUM(CASE WHEN ISNUMERIC(Time1) = 1 THEN CAST(Time1 AS INT) ELSE 0 END)), 4, 2) AS INT) / 60)) AS VARCHAR), 2)
                + ':'+ RIGHT('0' + CAST((CAST(SUBSTRING(dbo.fCore_IntToTime(SUM(CASE WHEN ISNUMERIC(Time1) = 1 THEN CAST(Time1 AS INT) ELSE 0 END)), 4, 2) AS INT) % 60) AS VARCHAR), 2) + ':' + RIGHT('0' + CAST(CAST(RIGHT(dbo.fCore_IntToTime(SUM(CASE WHEN ISNUMERIC(Time1) = 1 THEN CAST(Time1 AS INT) ELSE 0 END)), 2) AS INT) AS VARCHAR), 2), 108),':', '.') AS DECIMAL(18,2)
            )
            FROM vuCore_Timesheet_TimeandAttendanceInformation_Details
            WHERE SubProject > 0 AND SubProject = d.iMasterId), 0.00) ELSE 0.00 END AS [Actual Hours], 
     
           d.Deliverables,      
           c.iMasterId [StaffId],      
    
        -- Invoice Amount
        (SELECT ISNULL(SUM(TotalNetAmount), 0) FROM vCore_SalesInvoice x  
         WHERE x.SubProjectName = d.iMasterId) [Invoice Amt], 
        
        b.iMasterId, 
        e.sName [Assignment Type],  
  
        -- Remarks
        (SELECT TOP 1 ISNULL(b2.Remarks, '') 
         FROM vuCore_TaskAllocation_TaskAllocationStatus_Details b2 
         WHERE b2.SubProjectNo = b.SubProjectNo 
           AND LTRIM(RTRIM(ISNULL(b2.Remarks, ''))) <> '' 
         ORDER BY b2.iRowIndex DESC) Remarks1  
    
    FROM vCore_SalesExecutive c WITH (NOLOCK)      
    INNER JOIN vCore_SubProject d WITH (NOLOCK) ON d.SalesExecutiven = c.iMasterId     
    INNER JOIN vuCore_TaskAllocation_TaskAllocationStatus_Details b WITH (NOLOCK) ON b.SubProjectNo = d.iMasterId      
    LEFT JOIN vCore_TaskAllocationStatusUpdation a WITH (NOLOCK) ON b.TaskAllocationStatus = a.iMasterId      
    LEFT JOIN vCore_Product e WITH (NOLOCK) ON b.AssignmentType = e.iMasterId 
    --LEFT JOIN vCore_ForReport f with(nolock) on 
    WHERE d.iMasterId>0 AND d.SubProjectStatus <> 3
) AS SourceTable      
PIVOT (      
    MAX([Val])      
    FOR [Task Status] IN ([Confirmed], [Field Work], [Query Sent], [Query Solved],[Report Prepared], [Review], [Draft Issued No1], [Draft - Final], [Report Issued], [Signed], [Work Suspended])      
) AS PivotTable;


go 

CREATE OR ALTER VIEW nCore_AssignmentStatusReportFinal as
WITH Base AS (
    SELECT
        *,CAST(FLOOR([Estimated Hrs]) AS int) AS EstH,
        CAST(ROUND(([Estimated Hrs] - FLOOR([Estimated Hrs])) * 100, 0) AS int) AS EstM,
        CAST(FLOOR([Actual Hours]) AS int) AS ActH,
        CAST(ROUND(([Actual Hours] - FLOOR([Actual Hours])) * 100, 0) AS int) AS ActM
    FROM nCore_AssignmentStatusReport WITH(NOLOCK)
    WHERE StaffId>0
),
Diff AS (
    SELECT
        b.*,(b.EstH * 60 + b.EstM) - (b.ActH * 60 + b.ActM) AS VarTotalMinutes
    FROM Base b WITH(NOLOCK)
),
Normalized AS (
    SELECT
        d.*,CASE WHEN d.VarTotalMinutes < 0 THEN -1 ELSE 1 END AS VarSign,ABS(d.VarTotalMinutes) AS AbsVarMinutes
    FROM Diff d WITH(NOLOCK)
)
SELECT
    n.*,(n.AbsVarMinutes / 60) AS VarHoursPart,(n.AbsVarMinutes % 60) AS VarMinutesPart,
    CASE WHEN n.VarSign = -1 THEN '-' ELSE '' END
    + CAST(n.AbsVarMinutes / 60 AS varchar(10)) + '.'+ RIGHT('0' + CAST(n.AbsVarMinutes % 60 AS varchar(2)), 2) AS Variance_HH_Dot_MM,
    CAST(n.VarSign * ( (n.AbsVarMinutes / 60.0) ) AS decimal(18,2)) AS VarianceDecimalHours
FROM Normalized n WITH(NOLOCK);


